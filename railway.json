{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "mvn clean package -DskipTests",
    "watchPatterns": [
      "src/**/*",
      "pom.xml"
    ]
  },
  "deploy": {
    "startCommand": "java -jar target/chatwoot-backend-1.0.0.jar",
    "healthcheckPath": "/actuator/health",
    "healthcheckTimeout": 300,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 3
  },
  "environments": {
    "production": {
      "variables": {
        "SPRING_PROFILES_ACTIVE": "prod",
        "PORT": "8080",
        "JAVA_OPTS": "-Xmx1g -Xms512m -XX:+UseG1GC -XX:+UseStringDeduplication"
      }
    },
    "staging": {
      "variables": {
        "SPRING_PROFILES_ACTIVE": "staging",
        "PORT": "8080",
        "JAVA_OPTS": "-Xmx512m -Xms256m -XX:+UseG1GC"
      }
    },
    "development": {
      "variables": {
        "SPRING_PROFILES_ACTIVE": "dev",
        "PORT": "8080",
        "JAVA_OPTS": "-Xmx256m -Xms128m -XX:+UseG1GC"
      }
    }
  },
  "services": [
    {
      "name": "chatwoot-backend",
      "type": "application",
      "source": {
        "type": "github",
        "repo": "weavecode/chatwoot-weavecode",
        "branch": "main"
      },
      "domains": [
        {
          "name": "chat.weavecode.co.uk",
          "ssl": true
        }
      ],
      "scaling": {
        "min": 1,
        "max": 3,
        "target_cpu": 70,
        "target_memory": 80
      },
      "resources": {
        "cpu": "1x",
        "memory": "1GB"
      }
    }
  ],
  "plugins": [
    {
      "name": "postgresql",
      "version": "15",
      "variables": {
        "POSTGRES_DB": "chatwoot",
        "POSTGRES_USER": "chatwoot_user",
        "POSTGRES_PASSWORD": "{{.POSTGRES_PASSWORD}}"
      }
    },
    {
      "name": "redis",
      "version": "7",
      "variables": {
        "REDIS_PASSWORD": "{{.REDIS_PASSWORD}}"
      }
    }
  ],
  "monitoring": {
    "metrics": {
      "enabled": true,
      "endpoints": [
        "/actuator/metrics",
        "/actuator/prometheus"
      ]
    },
    "health": {
      "enabled": true,
      "endpoint": "/actuator/health"
    },
    "logs": {
      "enabled": true,
      "retention": "30d"
    }
  },
  "security": {
    "headers": {
      "X-Frame-Options": "DENY",
      "X-Content-Type-Options": "nosniff",
      "X-XSS-Protection": "1; mode=block",
      "Strict-Transport-Security": "max-age=31536000; includeSubDomains"
    }
  }
}
